import{_ as s,o as n,c as a,e as l}from"./app-gPvjP3ak.js";const p={},o=l(`<figure><img src="https://zero-space.s3.amazonaws.com/photos/bf30834c-a9de-41f4-9f39-4f44c2f2ff13x840.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><blockquote><p>由于最近公司在做图片相册选择上传的功能，对于图片的压缩算法这里我借鉴了 ochina 的 ios 端 App。其中有涉及到图片压缩的算法，这里贴出来留待后用;</p></blockquote><h3 id="gacompressionpichandle-h" tabindex="-1"><a class="header-anchor" href="#gacompressionpichandle-h" aria-hidden="true">#</a> GACompressionPicHandle.h</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="shiki one-dark-pro" style="background-color:#282c34;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">    	</span><span style="color:#C678DD;">#import</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&lt;Foundation/Foundation.h&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">    	</span><span style="color:#C678DD;">#import</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&lt;UIKit/UIKit.h&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">    	</span><span style="color:#C678DD;">#import</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&lt;CoreGraphics/CoreGraphics.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    	</span><span style="color:#C678DD;">@class</span><span style="color:#ABB2BF;"> GACompressionPicHandle;</span></span>
<span class="line"><span style="color:#ABB2BF;">    	</span><span style="color:#C678DD;">@protocol</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">GACompressionPicHandleDelegate</span><span style="color:#ABB2BF;"> &lt;NSObject&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">    	- (</span><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;">)CompressionPicHandle:(GACompressionPicHandle* )handle</span></span>
<span class="line"><span style="color:#ABB2BF;">      			CompressionFailureInfo:(</span><span style="color:#E5C07B;">NSString</span><span style="color:#ABB2BF;">* )info;</span></span>
<span class="line"><span style="color:#ABB2BF;">      	</span><span style="color:#C678DD;">@end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">      	</span><span style="color:#C678DD;">#define</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">CompressionMax_W</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">1224</span></span>
<span class="line"><span style="color:#ABB2BF;">      	</span><span style="color:#C678DD;">#define</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">CompressionMax_Size</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">300</span><span style="color:#ABB2BF;"> * </span><span style="color:#D19A66;">1024</span></span>
<span class="line"><span style="color:#ABB2BF;">      	</span><span style="color:#7F848E;font-style:italic;">/** OSChina 后台限制上传图片的大小*/</span></span>
<span class="line"><span style="color:#ABB2BF;">      	</span><span style="color:#C678DD;">#define</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">stand_size</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">1024</span><span style="color:#ABB2BF;"> * </span><span style="color:#D19A66;">800</span></span>
<span class="line"><span style="color:#ABB2BF;">      	</span><span style="color:#C678DD;">#define</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">min_compressionRatio</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0.3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">      	</span><span style="color:#C678DD;">@interface</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">GACompressionPicHandle</span><span style="color:#ABB2BF;"> : </span><span style="color:#E5C07B;">NSObject</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">      	+ (</span><span style="color:#C678DD;">instancetype</span><span style="color:#ABB2BF;">)shareCompressionPicHandle;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">@property</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">nonatomic</span><span style="color:#ABB2BF;">,</span><span style="color:#C678DD;">weak</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;">id</span><span style="color:#ABB2BF;">&lt;GACompressionPicHandleDelegate&gt; delegate;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    	</span><span style="color:#7F848E;font-style:italic;">/** 分辨率越小反而越占用时间 建议分辨率高的图片使用*/</span></span>
<span class="line"><span style="color:#ABB2BF;">    - (</span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;">* )scaleToSize:(CGSize)size</span></span>
<span class="line"><span style="color:#ABB2BF;">                   image:(UIImage* )picture;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">         </span><span style="color:#7F848E;font-style:italic;">/** 受到宽高比例问题 越接近正方形所用的时间越小 */</span></span>
<span class="line"><span style="color:#ABB2BF;">    - (</span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;"> *)imageByScalingAndCroppingForSize:(	CGSize)targetSize image:(UIImage *)image;</span></span>
<span class="line"><span style="color:#ABB2BF;">    	</span><span style="color:#C678DD;">@end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gacompressionpichandle-m" tabindex="-1"><a class="header-anchor" href="#gacompressionpichandle-m" aria-hidden="true">#</a> GACompressionPicHandle.m</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="shiki one-dark-pro" style="background-color:#282c34;" tabindex="0"><code><span class="line"><span style="color:#C678DD;">#import</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&quot;GACompressionPicHandle.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">@implementation</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">GACompressionPicHandle</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">static</span><span style="color:#ABB2BF;"> GACompressioinPicHandle*_shareCompressionPicHandle;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">+ (</span><span style="color:#C678DD;">instancetype</span><span style="color:#ABB2BF;">)</span><span style="color:#61AFEF;">shareCompressionPicHandle</span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">static</span><span style="color:#ABB2BF;"> dispatch_once_t onceToken;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">dispatch_once</span><span style="color:#ABB2BF;">(&amp;onceToken, ^{</span></span>
<span class="line"><span style="color:#ABB2BF;">        _shareCompressionPicHandle </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> 					[[GACompressionPicHandle </span><span style="color:#61AFEF;">alloc</span><span style="color:#ABB2BF;">]init];</span></span>
<span class="line"><span style="color:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> _shareCompressionPicHandle;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">- (</span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;">* )</span><span style="color:#61AFEF;">scaleToSize:</span><span style="color:#ABB2BF;">(CGSize)</span><span style="color:#ABB2BF;font-style:italic;">sizeimage</span><span style="color:#61AFEF;">:</span><span style="color:#ABB2BF;">(UIImage* )</span><span style="color:#ABB2BF;font-style:italic;">picture</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat width </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">CGImageGetWidth</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">picture</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">CGImage</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat height </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">CGImageGetHeight</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">picture</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">CGImage</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">float</span><span style="color:#ABB2BF;"> verticalRadio </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">size</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">height</span><span style="color:#ABB2BF;"> * </span><span style="color:#D19A66;">1.0</span><span style="color:#ABB2BF;"> / height;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">float</span><span style="color:#ABB2BF;"> horizontalRadio </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">size</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">width</span><span style="color:#ABB2BF;"> * </span><span style="color:#D19A66;">1.0</span><span style="color:#ABB2BF;"> / width;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">float</span><span style="color:#ABB2BF;"> radio </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(verticalRadio </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#ABB2BF;"> horizontalRadio </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    radio </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> verticalRadio </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> horizontalRadio </span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;"> horizontalRadio </span><span style="color:#C678DD;">:</span><span style="color:#ABB2BF;"> verticalRadio;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#ABB2BF;">    radio </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> verticalRadio </span><span style="color:#56B6C2;">&lt;</span><span style="color:#ABB2BF;"> horizontalRadio </span><span style="color:#C678DD;">?</span><span style="color:#ABB2BF;"> verticalRadio </span><span style="color:#C678DD;">:</span><span style="color:#ABB2BF;"> horizontalRadio;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    width </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> width * radio;</span></span>
<span class="line"><span style="color:#ABB2BF;">    height </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> height * radio;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> xPos </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">size</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">width</span><span style="color:#ABB2BF;"> - width) / </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> yPos </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">size</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">height</span><span style="color:#ABB2BF;"> - height) / </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">UIGraphicsBeginImageContext</span><span style="color:#ABB2BF;">(size);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    [picture </span><span style="color:#61AFEF;">drawInRect:CGRectMake</span><span style="color:#ABB2BF;">(xPos, yPos, width, height)];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    UIImage* scaledImage </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">UIGraphicsGetImageFromCurrentImageContext</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">UIGraphicsEndImageContext</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;">* scaledImageData </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">UIImageJPEGRepresentation</span><span style="color:#ABB2BF;">(scaledImage, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat compressionRatio </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0.9</span><span style="color:#E06C75;">f</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;">* tagerImageData </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> scaledImageData;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#56B6C2;">NSLog</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">@&quot;tagerImageData.length : </span><span style="color:#D19A66;">%lu</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">,(</span><span style="color:#C678DD;">unsigned</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">long</span><span style="color:#ABB2BF;">)</span><span style="color:#E5C07B;">tagerImageData</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">while</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">tagerImageData</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> stand_size </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#ABB2BF;"> compressionRatio </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (compressionRatio </span><span style="color:#56B6C2;">&lt;</span><span style="color:#ABB2BF;"> min_compressionRatio) {</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> ([_delegate </span><span style="color:#61AFEF;">respondsToSelector:</span><span style="color:#C678DD;">@selector(</span><span style="color:#61AFEF;">CompressionPicHandle:CompressionFailureInfo:</span><span style="color:#C678DD;">)</span><span style="color:#ABB2BF;">]) {</span></span>
<span class="line"><span style="color:#ABB2BF;">                [_delegate </span><span style="color:#61AFEF;">CompressionPicHandle:</span><span style="color:#E5C07B;">self</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">CompressionFailureInfo:</span><span style="color:#98C379;">@&quot;图片过大&quot;</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">        @autoreleasepool {</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;">* newCompressionData </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">UIImageJPEGRepresentation</span><span style="color:#ABB2BF;">(scaledImage, compressionRatio);</span></span>
<span class="line"><span style="color:#ABB2BF;">            tagerImageData </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> newCompressionData;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">        compressionRatio </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> compressionRatio - </span><span style="color:#D19A66;">0.12</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#56B6C2;">NSLog</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">@&quot;tagerImageData.length : </span><span style="color:#D19A66;">%lu</span><span style="color:#98C379;"> , compressionRatio : </span><span style="color:#D19A66;">%lf</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">tagerImageData</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;">,compressionRatio);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#56B6C2;">NSLog</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">@&quot;compressionRatio : </span><span style="color:#D19A66;">%lf</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">,compressionRatio);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> tagerImageData;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">- (</span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;"> *)</span><span style="color:#61AFEF;">imageByScalingAndCroppingForSize:</span><span style="color:#ABB2BF;">(CGSize)</span><span style="color:#ABB2BF;font-style:italic;">targetSize</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">image:</span><span style="color:#ABB2BF;">(UIImage *)</span><span style="color:#ABB2BF;font-style:italic;">image</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    UIImage *sourceImage </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> image;</span></span>
<span class="line"><span style="color:#ABB2BF;">    UIImage *newImage </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGSize imageSize </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">sourceImage</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">size</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat width </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">imageSize</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">width</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat height </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">imageSize</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">height</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat targetWidth </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">targetSize</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">width</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat targetHeight </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">targetSize</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">height</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat scaleFactor </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0.0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat scaledWidth </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> targetWidth;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat scaledHeight </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> targetHeight;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGPoint thumbnailPoint </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">CGPointMake</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0.0</span><span style="color:#ABB2BF;">,</span><span style="color:#D19A66;">0.0</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">CGSizeEqualToSize</span><span style="color:#ABB2BF;">(imageSize, targetSize) </span><span style="color:#56B6C2;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">NO</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat widthFactor </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> targetWidth / width;</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat heightFactor </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> targetHeight / height;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (widthFactor </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> heightFactor){</span></span>
<span class="line"><span style="color:#ABB2BF;">    scaleFactor </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> widthFactor; </span><span style="color:#7F848E;font-style:italic;">// scale to fit height</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#ABB2BF;">        scaleFactor </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> heightFactor; </span><span style="color:#7F848E;font-style:italic;">// scale to fit width</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    scaledWidth</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> width * scaleFactor;</span></span>
<span class="line"><span style="color:#ABB2BF;">    scaledHeight </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> height * scaleFactor;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (widthFactor </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> heightFactor) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">thumbnailPoint</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">y</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> (targetHeight - scaledHeight) * </span><span style="color:#D19A66;">0.5</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    } </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (widthFactor </span><span style="color:#56B6C2;">&lt;</span><span style="color:#ABB2BF;"> heightFactor){</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">thumbnailPoint</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">x</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> (targetWidth - scaledWidth) * </span><span style="color:#D19A66;">0.5</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">UIGraphicsBeginImageContext</span><span style="color:#ABB2BF;">(targetSize); </span><span style="color:#7F848E;font-style:italic;">// this will crop</span></span>
<span class="line"><span style="color:#ABB2BF;">    CGRect thumbnailRect </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> CGRectZero;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">thumbnailRect</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">origin</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> thumbnailPoint;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">thumbnailRect</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">size</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">width</span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> scaledWidth;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">thumbnailRect</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">size</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">height</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> scaledHeight;</span></span>
<span class="line"><span style="color:#ABB2BF;">    [sourceImage </span><span style="color:#61AFEF;">drawInRect:</span><span style="color:#ABB2BF;">thumbnailRect];</span></span>
<span class="line"><span style="color:#ABB2BF;">    newImage </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">UIGraphicsGetImageFromCurrentImageContext</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(newImage </span><span style="color:#56B6C2;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">UIGraphicsEndImageContext</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;">* scaledImageData </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">UIImageJPEGRepresentation</span><span style="color:#ABB2BF;">(newImage, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    CGFloat compressionRatio </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0.9</span><span style="color:#E06C75;">f</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;">* tagerImageData </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> scaledImageData;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#56B6C2;">NSLog</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">@&quot;tagerImageData.length : </span><span style="color:#D19A66;">%lu</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">,(</span><span style="color:#C678DD;">unsigned</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">long</span><span style="color:#ABB2BF;">)</span><span style="color:#E5C07B;">tagerImageData</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">while</span><span style="color:#ABB2BF;"> (</span><span style="color:#E5C07B;">tagerImageData</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> stand_size </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#ABB2BF;"> compressionRatio </span><span style="color:#56B6C2;">&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (compressionRatio </span><span style="color:#56B6C2;">&lt;</span><span style="color:#ABB2BF;"> min_compressionRatio) {</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> ([_delegate </span><span style="color:#61AFEF;">respondsToSelector:</span><span style="color:#C678DD;">@selector(</span><span style="color:#61AFEF;">CompressionPicHandle:CompressionFailureInfo:</span><span style="color:#C678DD;">)</span><span style="color:#ABB2BF;">]) {</span></span>
<span class="line"><span style="color:#ABB2BF;">                [_delegate </span><span style="color:#61AFEF;">CompressionPicHandle:</span><span style="color:#E5C07B;">self</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">CompressionFailureInfo:</span><span style="color:#98C379;">@&quot;图片过大&quot;</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">        @autoreleasepool {</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">NSData</span><span style="color:#ABB2BF;">* newCompressionData </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">UIImageJPEGRepresentation</span><span style="color:#ABB2BF;">(newImage, compressionRatio);</span></span>
<span class="line"><span style="color:#ABB2BF;">            tagerImageData </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> newCompressionData;</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">        compressionRatio </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> compressionRatio - </span><span style="color:#D19A66;">0.12</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#56B6C2;">NSLog</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">@&quot;tagerImageData.length : </span><span style="color:#D19A66;">%lu</span><span style="color:#98C379;"> , compressionRatio : </span><span style="color:#D19A66;">%lf</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">,</span><span style="color:#E5C07B;">tagerImageData</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">length</span><span style="color:#ABB2BF;">,compressionRatio);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#56B6C2;">NSLog</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">@&quot;compressionRatio : </span><span style="color:#D19A66;">%lf</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">,compressionRatio);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> tagerImageData;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,6),e=[o];function B(c,t){return n(),a("div",null,e)}const i=s(p,[["render",B],["__file","图片上传压缩算法.html.vue"]]);export{i as default};
