import{_ as o,r,o as p,c as B,b as a,e as i,w as l,a as t,d as e}from"./app-CBhv_KBJ.js";const c={},d={class:"table-of-contents"};function k(h,s){const n=r("router-link");return p(),B("div",null,[a("nav",d,[a("ul",null,[a("li",null,[i(n,{to:"#_1-定位问题"},{default:l(()=>s[0]||(s[0]=[e("1. 定位问题")])),_:1}),a("ul",null,[a("li",null,[i(n,{to:"#_1-1-关键"},{default:l(()=>s[1]||(s[1]=[e("1.1. 关键")])),_:1})]),a("li",null,[i(n,{to:"#_1-2-源码"},{default:l(()=>s[2]||(s[2]=[e("1.2. 源码")])),_:1})])])]),a("li",null,[i(n,{to:"#_2-调试"},{default:l(()=>s[3]||(s[3]=[e("2. 调试")])),_:1}),a("ul",null,[a("li",null,[i(n,{to:"#_2-1-准备工作"},{default:l(()=>s[4]||(s[4]=[e("2.1. 准备工作")])),_:1})]),a("li",null,[i(n,{to:"#_2-2-关键函数-commentbox-vue的submitcomment和watch"},{default:l(()=>s[5]||(s[5]=[e("2.2. 关键函数 CommentBox.vue的submitComment和watch")])),_:1})]),a("li",null,[i(n,{to:"#_2-3-断点测试-整体流程如下"},{default:l(()=>s[6]||(s[6]=[e("2.3. 断点测试，整体流程如下")])),_:1})]),a("li",null,[i(n,{to:"#_2-4-分析"},{default:l(()=>s[7]||(s[7]=[e("2.4. 分析")])),_:1})])])]),a("li",null,[i(n,{to:"#_3-验证"},{default:l(()=>s[8]||(s[8]=[e("3. 验证")])),_:1}),a("ul",null,[a("li",null,[i(n,{to:"#_3-1-至此问题解决"},{default:l(()=>s[9]||(s[9]=[e("3.1. 至此问题解决")])),_:1})])])]),a("li",null,[i(n,{to:"#_4-思考"},{default:l(()=>s[10]||(s[10]=[e("4. 思考")])),_:1})])])]),s[11]||(s[11]=t(`<div class="hint-container tip"><p class="hint-container-title">提示</p><p>前言： Waline 评论系统这个 bug 有几个月了，现象就是回复完其他人的评论后，评论内容会保留在顶部输入框中，而且不会自动清空。具体见 👉<a href="https://github.com/walinejs/waline/issues/2371" target="_blank" rel="noopener noreferrer">GitHub issuse #2173</a></p><p>许久未见修复，正好我有空，就看看这个问题，接下来跟我一起分析一下这个问题</p></div><h2 id="_1-定位问题" tabindex="-1"><a class="header-anchor" href="#_1-定位问题"><span>1. 定位问题</span></a></h2><p>问题现象上边已经描述过了，我们先来定位一下问题。</p><h3 id="_1-1-关键" tabindex="-1"><a class="header-anchor" href="#_1-1-关键"><span>1.1. 关键</span></a></h3><p>关键在于【不会清空】，即使刷新浏览器，也不会清空，由此可知必然保存在 localStorage 中，打开开发者工具，看看保存在 localStorage 中的数据结构。发现如下图所示</p><figure><img src="https://s3.bmp.ovh/imgs/2024/05/23/54fa93eb4563daea.png" alt="localStorage" tabindex="0" loading="lazy"><figcaption>localStorage</figcaption></figure><p>然后有了<strong>key</strong>就好办了</p><h3 id="_1-2-源码" tabindex="-1"><a class="header-anchor" href="#_1-2-源码"><span>1.2. 源码</span></a></h3><p>在 Waline 评论系统源码中，我们全局搜索 <code>WALINE_COMMENT_BOX_EDITOR</code> 结果如下</p><div class="language-ts line-numbers-mode" data-ext="ts" data-title="ts"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// walinejs/packages/client/src/composables/inputs.ts</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">import</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> type</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> { </span><span style="color:#E06C75;--shiki-dark:#E06C75;">RemovableRef</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> } </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;@vueuse/core&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">import</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> { </span><span style="color:#E06C75;--shiki-dark:#E06C75;">useStorage</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> } </span><span style="color:#C678DD;--shiki-dark:#C678DD;">from</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;@vueuse/core&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">export</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> interface</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> UserMeta</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    nick</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">string</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    mail</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">string</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    link</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">string</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">export</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> const</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> useUserMeta</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (): </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">RemovableRef</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">UserMeta</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; </span><span style="color:#C678DD;--shiki-dark:#C678DD;">=&gt;</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">useStorage</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">UserMeta</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;WALINE_USER_META&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, {</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    nick</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    mail</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    link</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#C678DD;--shiki-dark:#C678DD;">export</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> const</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> useEditor</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (): </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">RemovableRef</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">string</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; </span><span style="color:#C678DD;--shiki-dark:#C678DD;">=&gt;</span></span>
<span class="line highlighted"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">useStorage</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">string</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;WALINE_COMMENT_BOX_EDITOR&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续查找调用，找到<code>CommentBox.vue</code>关键组件，该组件将<em>textarea</em>评论框<strong>v-model</strong>与<code>useEditor</code>函数绑定，该函数返回一个<code>RemovableRef</code>，该类型为<code>&lt;string&gt;</code>。</p><div class="language-ts" data-ext="ts" data-title="ts"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">const</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> editor</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> useEditor</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span></code></pre></div><div class="language-vue" data-ext="vue" data-title="vue"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">textarea</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">  id</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;wl-edit&quot;</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">  ref</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;editorRef&quot;</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">  v-model</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">editor</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span></span>
<span class="line"><span style="color:#D19A66;--shiki-dark:#D19A66;">  class</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#98C379;--shiki-dark:#98C379;">&quot;wl-editor&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  :</span><span style="color:#D19A66;--shiki-dark:#D19A66;">placeholder</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">replyUser</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> ?</span><span style="color:#98C379;--shiki-dark:#98C379;"> \`@</span><span style="color:#C678DD;--shiki-dark:#C678DD;">\${</span><span style="color:#E06C75;--shiki-dark:#E06C75;">replyUser</span><span style="color:#C678DD;--shiki-dark:#C678DD;">}</span><span style="color:#98C379;--shiki-dark:#98C379;">\`</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> :</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> locale</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">placeholder</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  @</span><span style="color:#D19A66;--shiki-dark:#D19A66;">keydown</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">onKeyDown</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  @</span><span style="color:#D19A66;--shiki-dark:#D19A66;">drop</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">onDrop</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  @</span><span style="color:#D19A66;--shiki-dark:#D19A66;">paste</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">=</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span><span style="color:#E06C75;--shiki-dark:#E06C75;">onPaste</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">/&gt;</span></span></code></pre></div><h2 id="_2-调试" tabindex="-1"><a class="header-anchor" href="#_2-调试"><span>2. 调试</span></a></h2><h3 id="_2-1-准备工作" tabindex="-1"><a class="header-anchor" href="#_2-1-准备工作"><span>2.1. 准备工作</span></a></h3><ol><li><p>已锁定问题文件为<code>CommentBox.vue</code>,接下来开始 debug，因为准备提 PR，所以先 fork 一份</p></li><li><p>按照<a href="https://waline.js.org/advanced/contribution.html" target="_blank" rel="noopener noreferrer">waline-贡献指南</a>进行准备</p></li><li><p>先执行<code>pnpm i &amp; pnpm build</code>,本地调试依赖<code>@waline/api</code> 需要前置 build</p></li><li><p>使用 <code>pnpm client:dev</code> 启动 <code>@waline/client</code> 本地开发,由于 waline 是 Client/Server 架构，在调试 client 时，你需要设置 SERVERURL 为调试服务器（可以直接使用 vercel 的服务器），或同时启动下面的 server 开发服务器并使用默认的 <code>localhost:9090</code>。</p></li><li><p>使用 <code>pnpm server:dev</code> 启动 <code>@waline/server</code> 本地开发,配置必要的本地环境变量至 <code>example/.env</code>。（这里我配置了 <code>leancloud</code> 的环境变量，一直在报错）</p></li></ol><h3 id="_2-2-关键函数-commentbox-vue的submitcomment和watch" tabindex="-1"><a class="header-anchor" href="#_2-2-关键函数-commentbox-vue的submitcomment和watch"><span>2.2. 关键函数 <code>CommentBox.vue</code>的<code>submitComment</code>和<code>watch</code></span></a></h3><div class="language-ts line-numbers-mode" data-ext="ts" data-title="ts"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;"> const</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> submitComment</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> async</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (): </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Promise</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">void</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt; </span><span style="color:#C678DD;--shiki-dark:#C678DD;">=&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">     // 此处...省略若干</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">     try</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E06C75;--shiki-dark:#E06C75;">recaptchaV3Key</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">         comment</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">recaptchaV3</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">             await</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> useReCaptcha</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E06C75;--shiki-dark:#E06C75;">recaptchaV3Key</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">).</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">execute</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;social&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E06C75;--shiki-dark:#E06C75;">turnstileKey</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">         comment</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">turnstile</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> await</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> useTurnstile</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E06C75;--shiki-dark:#E06C75;">turnstileKey</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">).</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">execute</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;social&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         const</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> options</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">         serverURL</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">         lang</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">         token</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">userInfo</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">?.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">token</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">         comment</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         const</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> response</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> await</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">props</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">edit</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         ?</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> updateComment</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">({</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">             objectId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">props</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">edit</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">objectId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">             ...</span><span style="color:#E06C75;--shiki-dark:#E06C75;">options</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">         })</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         :</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> addComment</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E06C75;--shiki-dark:#E06C75;">options</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">         isSubmitting</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> false</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">response</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">errmsg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">return</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> alert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">response</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">errmsg</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">         emit</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;submit&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">response</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">data</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">!</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">         editor</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">         previewText</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#98C379;--shiki-dark:#98C379;"> &#39;&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">props</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">replyId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">emit</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;cancelReply&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">         if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">props</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">edit</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">?.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">objectId</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">emit</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;cancelEdit&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     } </span><span style="color:#C678DD;--shiki-dark:#C678DD;">catch</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">err</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">unknown</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">         isSubmitting</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#D19A66;--shiki-dark:#D19A66;"> false</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">         alert</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">((</span><span style="color:#E06C75;--shiki-dark:#E06C75;">err</span><span style="color:#C678DD;--shiki-dark:#C678DD;"> as</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> TypeError</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">).</span><span style="color:#E06C75;--shiki-dark:#E06C75;">message</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">     }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> };</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来看 watch</p><div class="language-ts line-numbers-mode" data-ext="ts" data-title="ts"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">watch</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  () </span><span style="color:#C678DD;--shiki-dark:#C678DD;">=&gt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> editor</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  (</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">=&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    const</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> { </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">highlighter</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">texRenderer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> } </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> config</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">    content</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">    previewText</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> parseMarkdown</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, {</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      emojiMap</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">emoji</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">map</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      highlighter</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      texRenderer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">    wordNumber</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> getWordNumber</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">autosize</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">editorRef</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">!</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    else</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> autosize</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">destroy</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">editorRef</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">!</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  },</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line highlighted"><span style="color:#E06C75;--shiki-dark:#E06C75;">    immediate</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">true</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-断点测试-整体流程如下" tabindex="-1"><a class="header-anchor" href="#_2-3-断点测试-整体流程如下"><span>2.3. 断点测试，整体流程如下</span></a></h3><ol><li><p>监听<code>editor.value</code>，并将<strong>editor</strong>和<strong>textarea</strong>绑定,用户输入的值自动保存在<strong>localStorage</strong>中</p></li><li><p>点击提交按钮，将<strong>textarea</strong>中的值发送给后端，收到回调后将<strong>editor</strong>清空,如果抛出异常则不清空</p></li><li><p>正常提交评论无异常，在<code>submitComment</code>函数中的<code>editor.value = &#39;&#39;;</code>将<strong>localStorage</strong>存储的内容清空</p></li><li><p>回复他人评论时，前置流程提交和步骤 3 一致，然后触发了<code>watch</code>,此时<code>watch</code>监听到的<strong>value</strong>为未被清空的值，既之前用户输入的内容</p></li><li><p><code>submitComment</code>中的<code>editor.value = &#39;&#39;;</code>和<code>watch</code>都打上了断点，先赋值为空，后触发<code>watch</code>，而此时<code>watch</code>的 value 为被清空之前的值，即用户输入的内容</p></li></ol><h3 id="_2-4-分析" tabindex="-1"><a class="header-anchor" href="#_2-4-分析"><span>2.4. 分析</span></a></h3><p>问题已经定位到代码级别，接下来只需要找到 watch 被触发的原因即可，初步猜测可能原因：</p><p><code>submitComment</code>是异步函数，其内部赋空值后，<code>editor.value=&#39;&#39;</code>没有及时更新，导致<code>watch</code>触发取到旧值</p><p>遂添加 watch 的 bebug 函数加以验证</p><ol><li><code>onTrack</code> 将在响应属性或引用作为依赖项被跟踪时被调用。相当于 get</li><li><code>onTrigger</code> 将在侦听器回调被依赖项的变更触发时被调用。相当于 set</li></ol><div class="language-ts line-numbers-mode" data-ext="ts" data-title="ts"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">watch</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  () </span><span style="color:#C678DD;--shiki-dark:#C678DD;">=&gt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> editor</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  (</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#C678DD;--shiki-dark:#C678DD;">=&gt;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    const</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> { </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">highlighter</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">texRenderer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> } </span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">=</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> config</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">    content</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#E06C75;--shiki-dark:#E06C75;"> value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">    previewText</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> parseMarkdown</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, {</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      emojiMap</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">emoji</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">map</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      highlighter</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">      texRenderer</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">    wordNumber</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> getWordNumber</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    if</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;"> (</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) </span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">autosize</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">editorRef</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">!</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">    else</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> autosize</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">destroy</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">editorRef</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;">!</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  },</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="color:#E06C75;--shiki-dark:#E06C75;">    immediate</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: </span><span style="color:#D19A66;--shiki-dark:#D19A66;">true</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">    onTrack</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">e</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">      // 当 editor.value 被追踪为依赖时触发</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      debugger</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    },</span></span>
<span class="line"><span style="color:#61AFEF;--shiki-dark:#61AFEF;">    onTrigger</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#E06C75;--shiki-dark:#E06C75;font-style:italic;--shiki-dark-font-style:italic;">e</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">      // 当 editor.value 被更改时触发</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">      debugger</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">    },</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果为：</p><ol><li><code>editor.value=&#39;&#39;</code>时，<code>onTrigger</code>触发，newValue 为<code>&#39;&#39;</code></li><li>紧接着触发<code>onTrack</code>value 为旧值</li></ol><p>调整回调的触发时机试试看：</p><ul><li><p><a href="https://cn.vuejs.org/guide/essentials/watchers.html#post-watchers" target="_blank" rel="noopener noreferrer">Post Watchers</a></p><p>如果想在侦听器回调中能访问被 Vue 更新<strong>之后</strong>的所属组件的 DOM，你需要指明 <code>flush: &#39;post&#39;</code> 选项：</p></li><li><p><a href="https://cn.vuejs.org/guide/essentials/watchers.html#sync-watchers" target="_blank" rel="noopener noreferrer">同步侦听器</a></p><p>它会在 Vue 进行任何更新之前触发：</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>同步侦听器不会进行批处理，每当检测到响应式数据发生变化时就会触发。可以使用它来监视简单的布尔值，但应避免在可能多次同步修改的数据源 (如数组) 上使用。</p></div></li></ul><p>结果是没有作用，但在更改为 sync 后，发现了一件有趣的事情，因为 sync 不会进行批处理的特性，所以触发了两次<code>onTrack</code>,我们来看一下两次的堆栈信息</p><figure><img src="https://s3.bmp.ovh/imgs/2024/05/23/f4ffa6bb556812cc.png" alt="第一次" tabindex="0" loading="lazy"><figcaption>第一次</figcaption></figure><figure><img src="https://s3.bmp.ovh/imgs/2024/05/23/33bc634ac459ec19.png" alt="第二次" tabindex="0" loading="lazy"><figcaption>第二次</figcaption></figure><p>很明显第一次触发是<code>editor.value=&#39;&#39;</code>时触发的，第二次触发异步的，在<code>submitComment</code>还未执行完成时就触发了，点击堆栈信息定位到了<strong>291</strong>行，很明显早于<code>editor.value=&#39;&#39;</code>的<strong>297</strong>行。所以取到的是旧的值，虽然断点是<code>editor.value=&#39;&#39;</code>先执行，但<code>submitComment</code>是异步的，watch 取到的是旧值，那接下来就需要看 <mark><code>watch</code>是被什么触发了</mark></p><p>由于源码中的<code>watch</code>是写在<code>onMounted</code>中的，断点确定二次走到<code>watch</code>中时，是触发了<code>onMounted</code>，那触发<code>onMounted</code>是组件重新加载了，查找后得知，整体逻辑是，评论区域，代码结构如下：</p><ul><li><p>组件为<code>WalineComment.vue</code>,其中包含了评论列表组件 item<code>CommentCard.vue</code>和顶部默认输入框<code>CommentBox.vue</code></p></li><li><p>针对文章发布评论使用的是顶部的<code>CommentBox.vue</code>组件</p></li><li><p>针对评论回复时，使用的是<code>CommentCard.vue</code>-<code>CommentBox.vue</code></p></li><li><p>回复完成后<code>CommentCard.vue</code>-<code>CommentBox.vue</code>销毁，顶部的<code>CommentBox.vue</code>组件重新渲染</p></li></ul><p><mark>顶部的<code>CommentBox.vue</code>组件重新渲染会触发 watch，此时取值是旧值，</mark> 经查看，<code>submitComment</code>中的<code>editor.value=&#39;&#39;</code>执行完后， <code>localStorage</code> 中的值并未立即修改，所以重新渲染的顶部<code>CommentBox.vue</code>组件在初始化时取到的值仍为<code>localStorage</code>中的旧值。</p><h2 id="_3-验证" tabindex="-1"><a class="header-anchor" href="#_3-验证"><span>3. 验证</span></a></h2><p>上边已经基本确定问题出在这句上</p><div class="language-ts" data-ext="ts" data-title="ts"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">editor</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#E06C75;--shiki-dark:#E06C75;">value</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#98C379;--shiki-dark:#98C379;"> &quot;&quot;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><div class="language-ts" data-ext="ts" data-title="ts"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">const</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> editor</span><span style="color:#56B6C2;--shiki-dark:#56B6C2;"> =</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> useEditor</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">();</span></span></code></pre></div><p>而在 <a href="#_1-2-%E6%BA%90%E7%A0%81">1.2</a> 中可以看到<code>useEditor()</code>是<code>@vueuse/core</code>的导出函数,怀疑其内部实现有一些异步操作，导致的没有立即更新<code>localStorage</code></p><div class="language-ts" data-ext="ts" data-title="ts"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// 更换\`editor.value\`为</span></span>
<span class="line"><span style="color:#E5C07B;--shiki-dark:#E5C07B;">localStorage</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">.</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">setItem</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;WALINE_COMMENT_BOX_EDITOR&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">, </span><span style="color:#98C379;--shiki-dark:#98C379;">&#39;&#39;</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#7F848E;--shiki-dark:#7F848E;font-style:italic;--shiki-dark-font-style:italic;">// 或</span></span>
<span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">await</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> nextTick</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">()</span></span></code></pre></div><h3 id="_3-1-至此问题解决" tabindex="-1"><a class="header-anchor" href="#_3-1-至此问题解决"><span>3.1. 至此问题解决</span></a></h3><div class="hint-container info"><p class="hint-container-title">相关信息</p><p><strong>nextTick()</strong></p><p>等待下一次 DOM 更新刷新的工具方法。</p><ul><li>类型</li></ul><div class="language-ts" data-ext="ts" data-title="ts"><pre class="shiki shiki-themes one-dark-pro one-dark-pro vp-code" style="background-color:#282c34;--shiki-dark-bg:#282c34;color:#abb2bf;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#C678DD;--shiki-dark:#C678DD;">function</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;"> nextTick</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">(</span><span style="color:#61AFEF;--shiki-dark:#61AFEF;">callback</span><span style="color:#C678DD;--shiki-dark:#C678DD;">?</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">: () </span><span style="color:#C678DD;--shiki-dark:#C678DD;">=&gt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;"> void</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">): </span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">Promise</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#E5C07B;--shiki-dark:#E5C07B;">void</span><span style="color:#ABB2BF;--shiki-dark:#ABB2BF;">&gt;</span></span></code></pre></div><ul><li>详细信息</li></ul><p>当你在 Vue 中更改响应式状态时，最终的 DOM 更新并不是同步生效的，而是由 Vue 将它们缓存在一个队列中，直到下一个“tick”才一起执行。这样是为了确保每个组件无论发生多少状态改变，都仅执行一次更新。</p><p><strong>nextTick()</strong> 可以在状态改变后立即使用，以等待 DOM 更新完成。你可以传递一个回调函数作为参数，或者 await 返回的 Promise。</p></div><h2 id="_4-思考" tabindex="-1"><a class="header-anchor" href="#_4-思考"><span>4. 思考</span></a></h2><p>在<a href="https://www.vueusejs.com/core/useStorage/#usage" target="_blank" rel="noopener noreferrer">vueusejs</a>的文档中，其实<code>useStorage</code>应该是一个同步操作，它还有一个<code>useStorageAsync</code>的API，支持异步的响应式Storage，按理说里边不应该包含太多异步的或者延时性的代码，我也找到源码浅浅看了一下，目前还没找到问题在哪里，按照替换<code>localStorage.setItem(&#39;WALINE_COMMENT_BOX_EDITOR&#39;, &#39;&#39;);</code>可行来看，问题就在<code>useStorage</code>身上无疑，后续有时间，会继续探索一下，给官方的PR<a href="https://github.com/walinejs/waline/pull/2524" target="_blank" rel="noopener noreferrer">#2524</a>也已经提了</p>`,49))])}const y=o(c,[["render",k],["__file","waline-bug.html.vue"]]),A=JSON.parse(`{"path":"/posts/Web/Vue/waline-bug.html","title":"一个 waline 评论系统bug引发的思考","lang":"zh-CN","frontmatter":{"title":"一个 waline 评论系统bug引发的思考","icon":"hk-waline","date":"2024-05-23T00:00:00.000Z","star":true,"headerDepth":3,"cover":"https://files.codelife.cc/wallhaven/full/6d/wallhaven-6d7xmx.jpg?x-oss-process=image/resize,limit_0,m_fill,w_1366,h_768/quality,Q_92/format,webp","category":["Vue"],"tag":["Vue响应式"],"description":"提示 前言： Waline 评论系统这个 bug 有几个月了，现象就是回复完其他人的评论后，评论内容会保留在顶部输入框中，而且不会自动清空。具体见 👉GitHub issuse #2173 许久未见修复，正好我有空，就看看这个问题，接下来跟我一起分析一下这个问题 1. 定位问题 问题现象上边已经描述过了，我们先来定位一下问题。 1.1. 关键 关键在...","head":[["meta",{"property":"og:url","content":"https://oragekk.me/posts/Web/Vue/waline-bug.html"}],["meta",{"property":"og:site_name","content":"Oragekk's Blog"}],["meta",{"property":"og:title","content":"一个 waline 评论系统bug引发的思考"}],["meta",{"property":"og:description","content":"提示 前言： Waline 评论系统这个 bug 有几个月了，现象就是回复完其他人的评论后，评论内容会保留在顶部输入框中，而且不会自动清空。具体见 👉GitHub issuse #2173 许久未见修复，正好我有空，就看看这个问题，接下来跟我一起分析一下这个问题 1. 定位问题 问题现象上边已经描述过了，我们先来定位一下问题。 1.1. 关键 关键在..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://files.codelife.cc/wallhaven/full/6d/wallhaven-6d7xmx.jpg?x-oss-process=image/resize,limit_0,m_fill,w_1366,h_768/quality,Q_92/format,webp"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-05-24T01:50:38.000Z"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://files.codelife.cc/wallhaven/full/6d/wallhaven-6d7xmx.jpg?x-oss-process=image/resize,limit_0,m_fill,w_1366,h_768/quality,Q_92/format,webp"}],["meta",{"name":"twitter:image:alt","content":"一个 waline 评论系统bug引发的思考"}],["meta",{"property":"article:author","content":"Oragekk"}],["meta",{"property":"article:tag","content":"Vue响应式"}],["meta",{"property":"article:published_time","content":"2024-05-23T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-05-24T01:50:38.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"一个 waline 评论系统bug引发的思考\\",\\"image\\":[\\"https://s3.bmp.ovh/imgs/2024/05/23/54fa93eb4563daea.png\\",\\"https://s3.bmp.ovh/imgs/2024/05/23/f4ffa6bb556812cc.png\\",\\"https://s3.bmp.ovh/imgs/2024/05/23/33bc634ac459ec19.png\\"],\\"datePublished\\":\\"2024-05-23T00:00:00.000Z\\",\\"dateModified\\":\\"2024-05-24T01:50:38.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Oragekk\\",\\"url\\":\\"https://orgaekk.me\\"}]}"]]},"headers":[{"level":2,"title":"1. 定位问题","slug":"_1-定位问题","link":"#_1-定位问题","children":[{"level":3,"title":"1.1. 关键","slug":"_1-1-关键","link":"#_1-1-关键","children":[]},{"level":3,"title":"1.2. 源码","slug":"_1-2-源码","link":"#_1-2-源码","children":[]}]},{"level":2,"title":"2. 调试","slug":"_2-调试","link":"#_2-调试","children":[{"level":3,"title":"2.1. 准备工作","slug":"_2-1-准备工作","link":"#_2-1-准备工作","children":[]},{"level":3,"title":"2.2. 关键函数 CommentBox.vue的submitComment和watch","slug":"_2-2-关键函数-commentbox-vue的submitcomment和watch","link":"#_2-2-关键函数-commentbox-vue的submitcomment和watch","children":[]},{"level":3,"title":"2.3. 断点测试，整体流程如下","slug":"_2-3-断点测试-整体流程如下","link":"#_2-3-断点测试-整体流程如下","children":[]},{"level":3,"title":"2.4. 分析","slug":"_2-4-分析","link":"#_2-4-分析","children":[]}]},{"level":2,"title":"3. 验证","slug":"_3-验证","link":"#_3-验证","children":[{"level":3,"title":"3.1. 至此问题解决","slug":"_3-1-至此问题解决","link":"#_3-1-至此问题解决","children":[]}]},{"level":2,"title":"4. 思考","slug":"_4-思考","link":"#_4-思考","children":[]}],"git":{"createdTime":1716468743000,"updatedTime":1716515438000,"contributors":[{"name":"oragekk","email":"oragekk@163.com","commits":3}]},"readingTime":{"minutes":6.61,"words":1983},"filePathRelative":"posts/Web/Vue/waline-bug.md","localizedDate":"2024年5月23日","excerpt":"\\n<div class=\\"hint-container tip\\">\\n<p class=\\"hint-container-title\\">提示</p>\\n<p>前言： Waline 评论系统这个 bug 有几个月了，现象就是回复完其他人的评论后，评论内容会保留在顶部输入框中，而且不会自动清空。具体见 👉<a href=\\"https://github.com/walinejs/waline/issues/2371\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">GitHub issuse #2173</a></p>\\n<p>许久未见修复，正好我有空，就看看这个问题，接下来跟我一起分析一下这个问题</p>\\n</div>","autoDesc":true}`);export{y as comp,A as data};
